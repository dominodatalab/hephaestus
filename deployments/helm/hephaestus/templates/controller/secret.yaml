apiVersion: v1
kind: Secret
metadata:
  name: {{ include "hephaestus.configSecretName" . }}
  labels:
    {{- include "hephaestus.controller.labels.standard" . | nindent 4 }}
type: Opaque
stringData:
  config.yaml: |
    buildkit:
      namespace: {{ include "hephaestus.buildkit.namespace" . }}
      daemonPort: {{ .Values.buildkit.service.port }}
      serviceName: {{ include "hephaestus.buildkit.fullname" . }}
      statefulSetName: {{ include "hephaestus.buildkit.fullname" . }}
      {{- if .Values.buildkit.mtls.enabled }}
      mtls:
        caCertPath: /etc/hephaestus/x509/ca.crt
        certPath: /etc/hephaestus/x509/tls.crt
        keyPath: /etc/hephaestus/x509/tls.key
      {{- end }}
      podLabels:
        {{- include "hephaestus.buildkit.labels.matchLabels" . | nindent 8 }}
      {{- with .Values.controller.manager.poolSyncWaitTime }}
      poolSyncWaitTime: {{ . | quote }}
      {{- end }}
      {{- with .Values.controller.manager.poolMaxIdleTime }}
      poolMaxIdleTime: {{ . | quote }}
      {{- end }}
      {{- with .Values.controller.manager.poolWatchTimeout }}
      poolWatchTimeout {{ . | quote }}
      {{- end }}
      {{- with .Values.controller.manager.secrets }}
      secrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
    {{- with .Values.controller.manager }}
    imageBuildMaxConcurrency: {{ .imageBuildMaxConcurrency }}
    manager:
      healthProbeAddr: ":{{ .healthProbePort }}"
      metricsAddr: ":{{ .metricsPort }}"
      webhookPort: {{ .webhookPort }}
      watchNamespaces: {{ .watchNamespaces }}
      enabledLeaderElection: {{ gt ($.Values.controller.replicaCount | int) 1 }}
    logging:
      stacktraceLevel: {{ .logging.stacktraceLevel | quote }}
      container:
        encoder: {{ .logging.container.encoding | quote }}
        level: {{ .logging.container.level | quote }}
      logfile:
        enabled: {{ $.Values.controller.vector.enabled }}
        filepath: {{ include "hephaestus.logfilePath" $ | quote }}
        level: {{ .logging.logfile.level | quote }}
    messaging:
      {{- with .messaging }}
      enabled: {{ .enabled }}
      amqp:
        url: {{ .amqp.url | quote }}
        exchange: {{ .amqp.exchange | quote }}
        queue: {{ .amqp.queue | quote }}
      kafka: {{ .kafka | toYaml }}
      {{- end }}
    {{- end }}
  {{- if .Values.controller.vector.enabled }}
  vector.yaml: |
    sources:
      hephaestus_output:
        type: file
        include:
          - {{ include "hephaestus.logfilePath" . }}
    {{- with .Values.controller.vector.config.transforms }}
    transforms:
      {{- toYaml . | nindent 6 }}
    {{- end }}
    {{- with .Values.controller.vector.config.sinks }}
    sinks:
      {{- toYaml . | nindent 6 }}
    {{- end }}
  {{- end }}
