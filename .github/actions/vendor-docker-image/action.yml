name: Vendor Docker Image
description: Extracts Docker image details from the local Helm chart and pushes it to Quay
inputs:
  query:
    required: true
    description: YQ query that points to the image definition inside the values.yaml file
  username:
    required: true
    description: Quay registry username
  password:
    required: true
    description: Quay registry password
runs:
  using: composite
  steps:
    - id: image_source
      name: Extract image details from Helm values
      uses: mikefarah/yq@v4.25.1
      with:
        cmd: yq '${{ inputs.query }} | .repository + ":" + .tag' deployments/helm/hephaestus/values.yaml

    - id: image_fields
      name: Process image fields
      shell: bash
      run: echo ::set-output name=result::"$(echo ${{ steps.image_source.outputs.result }} | awk -F/ '{print $NF}')"

    - name: Login to container registry
      uses: docker/login-action@v1
      with:
        registry: quay.io
        username: ${{ inputs.username }}
        password: ${{ inputs.password }}

    - name: Tag and push image
      uses: akhilerm/tag-push-action@v2.0.0
      with:
        src: ${{ steps.image_source.outputs.result }}
        dst: quay.io/domino/${{ steps.image_fields.outputs.result }}
